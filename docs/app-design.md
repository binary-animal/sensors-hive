## Архитектура приложения
---

### Понятия

**Сенсор** - внешний по отношению к приложению источник цифровых данных. В любом момент времени приложение может запросить показания сенсора, получив ***значение***.

- Значение всегда является одним вещественным числом
- Приложение не может изменять показания сенсора, только считывать текущее значение
- У каждого сенсора есть свой заранее известный **диапазон допустимых значений**, любые числа вне которого не являются осмысленными показаниями
- Если сенсор возвращает такое значение, приложение расценивает это как поломку/ошибку

**Управляющий параметр** (УП) - внешний по отношению к приложению блок данных. Приложение может либо прочитать данные из этого блока, получив ***значение УП***, либо записать в блок свои данные

- Значение может меняться со временем под воздействием внешних обстоятельств без участия приложения
- УП может на некоторых отрезках времени становиться недоступным для записи со стороны приложения
- У каждого УП есть заранее известный *диапазон допустимых значений*, любые значения вне которого не смогут быть записаны в качестве нового
- Если УП возвращает значение, не входящее в диапазон допустимых значений, приложение расценивает это как ошибку
- УП может являться неотъемлемой частью сенсора и влять на его показания.

**Улей** - совокупность всех сенсоров и управляющих параметров, с которыми взаимодействует приложение

**Состояние улья** - совокупность всех значений улья в определенный момент времени

Между приложением и ульем существует промежуточный слой абстракции, вбирающий в себя все нюансы реализации считывания и записи данных. Это набор алгоритмов, написанных для взаимодействия с конкретными видами сенсоров и УП. Все они общаются с приложением посредством двух унифицированных моделей данных:

**Модель данных сенсора**
- уникальный идентификатор
- тип
- модель
- единицы измерения
- частота опроса
- текущее значение
- диапазон допустимых значений
- геопозиция
- текстовое название
- текстовое описание
- набор управляющих параметров сенсора

**Модель данных УП**
- уникальный идентификатор
- идентификатор сенсора-хозяина [опционально]
- тип
- текущее значение
- текстовое название
- текстовое описание
- диапазон допустимых значений
- геопозиция

### Задачи серверной части приложения

- Хранение и администрирование моделей данных улья
- Обеспечение оперативного доступа к актуальному состоянию улья
- Журналирование предыдущих состояний и обеспечение к ним доступа
- Предоставление инструментария для произвольной группировки моделей в улье
- Разграничение пользовательского доступа к хранящейся информации и инструментам взаимодействия с ульем
- Предоставление API на базе HTTP
- Хранение пользовательской информации клиентского приложения и всех настроек приложения
- Генерация событий и отчетов в соответствии с настройками, оповещение подписчиков по выбранным в настройках каналам
- Автоматическое внесение изменений в состояние улья по расписанию или по срабатыванию условных триггеров

### Задачи клиентской части

- Предоставление удобного веб-интерфейса для всех действий пользователя включая администрирование приложения
- Взаимодействие с серверной частью через API
- Предоставление гибких инструментов для создания и кастомизации интерфейсов мониторинга, анализа и управления
- Мониторинг, анализ и управление состоянием улья
- Оповещение о событиях в системе, просмотр отчетов, настройка генерации событий и отчетов

### Структура данных

**Блок**
- id
- геопозиция
- название
- описание
- список сенсоров
- список параметров

**Сенсор**
- id
- тип
- модель
- единицы измерения
- текущее значение
- частота опроса
- диапазон допустимых значений
- диапазон безопасных значений
- геопозиция
- текстовое название
- текстовое описание
- параметры
- драйвер
- настройки драйвера

**Параметр**
- id
- id сенсора [опционально]
- тип
- текущее значение
- текстовое название
- текстовое описание
- диапазон допустимых значений
- геопозиция
- драйвер
- настройки драйвера

**Журнал состояний улья**
- id
- временная метка
- тип события
- id породившей сущности
- значение

**Пользователь**
- id
- email
- имя
- пароль
- список групп
- настройки профиля и интерфейса

**Группа**
- id
- название
- описание
- список пользователей

**Список контроля доступа**
- id
- id группы
- тип ресурса
- id ресурса

**Автоматическое изменение параметра**
- id
- id параметра
- новое значение
- периодичность
- событие-триггер

**Событие**
- id
- правило возникновения
- список подписчиков
- тип
- каналы доставки
- список автоматических изменений параметров

**Очередь событий**
- id
- id события
- временная метка
- данные

**Отчет**
- id
- периодичность
- правило генерации
- список подписчиков
- тип
- каналы доставки

### Web API

**Общие положения**

* Вся пересылаемая информация кодируется в формате JSON и пересылается по протоколу HTTP/HTTPS

* Работа пользователя с приложением всегда начинается с запроса на авторизацию

* Результатом успешной авторизации является пользовательский токен, который должен быть использован в начале каждого следующего запроса

* Каждый ответ сервера содержит в начале статус, сообщающий успешно ли выполнен запрос

**Все вызовы API делятся на следующие категории:**
* Авторизация
* Получение актуального состояния улья
* Получение данных по предыдущим состояниям улья
* Изменение актуального состояния улья
* Изменение структуры улья
* Сохранение и извлечение пользовательских настроек
* Администрирование пользователей
* Администрирование приложения
* Управление событиями, отчетами и автоматическими изменениями
